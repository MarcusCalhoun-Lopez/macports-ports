# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

PortSystem                              1.0
PortGroup           gcc_build           1.0

epoch               7

name                gcc10
version             10.4.0
revision            5

platforms           {darwin >= 10 < 22}

checksums           rmd160  5095b725b8846a4946495f5415aab02c3352d763 \
                    sha256  c9297d5bcd7cb43f3dfc2fed5389e948c9312fd962ef6a4ce455cff963ebe4f1 \
                    size    75018092

set libgccname      lib${name}
subport             ${libgccname} { revision [ expr ${revision} + 0 ] }

if { ${os.platform} eq "darwin" } {
    # Patch generated from https://github.com/iains/gcc-10-branch
    # git diff --no-prefix  releases/gcc-10.4.0 gcc-10-4-darwin-pre-r0
    patchfiles-append  patch-darwin-gcc-${version}.diff
    # https://gcc.gnu.org/bugzilla/show_bug.cgi?id=92061
    patchfiles-append  patch-genconditions.diff
}

if { ${os.platform} eq "darwin" } {
    # Bootstrap comparison fails on 10.6, so disable
    #   https://trac.macports.org/ticket/65280
    if { (${os.major} <= 10) } \
    {
        # Skip bootstrap comparison entirely
        post-patch {
            reinplace {s|^do-compare =|do-compare = /usr/bin/true|g} \
                ${worksrcpath}/Makefile.in \
                ${worksrcpath}/config/bootstrap-debug.mk \
                ${worksrcpath}/config/bootstrap-debug-lean.mk \
                ${worksrcpath}/config/bootstrap-debug-lib.mk
        }
    }
}

# https://trac.macports.org/ticket/29067
# https://trac.macports.org/ticket/29104
# https://trac.macports.org/ticket/47996
# https://trac.macports.org/ticket/58493
compiler.blacklist-append {clang < 800}  gcc-4.0 *gcc-4.2 {macports-clang-3.[4-7]}

# clang (as) from Xcode 12.5 has various problems with gcc build
if { ${os.platform} eq "darwin" && \
         ([vercmp ${xcodeversion} >= 12.5] || [vercmp ${xcodecltversion} >= 12.5]) } {
    pre-configure {
        ui_warn "Applying '--without-build-config' workaround to Xcode ${xcodeversion} / CLT ${xcodecltversion}"
        ui_warn "If versions > 12.5 please check if it is still required"
    }
    # gcc has build issues on macOS 11.3 with the use of Xcode clang as 'as'
    # https://gcc.gnu.org/bugzilla/show_bug.cgi?id=100340
    # https://trac.macports.org/ticket/62775
    configure.args-append  --without-build-config
}
