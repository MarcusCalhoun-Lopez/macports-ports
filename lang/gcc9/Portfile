# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

PortSystem                              1.0
PortGroup           gcc_build           1.0
PortGroup           xcode_workaround    1.0

epoch               3
name                gcc9
version             9.5.0
revision            1
subport             libgcc9 { revision 2 }
platforms           {darwin >= 10 < 15}

checksums           rmd160  2ba36108599ceee93931722d98e0d5280037b05c \
                    sha256  27769f64ef1d4cd5e2be8682c0c93f9887983e6cfd1a927ce5a0a2915a95cf8f \
                    size    72462752

patchfiles          patch-fix-libgccjit-soname

patchfiles-append   patch-darwin21-support.diff

if { ${os.platform} eq "darwin" && ${os.major} > 19 } {
    # https://gcc.gnu.org/bugzilla/show_bug.cgi?id=92061
    patchfiles-append patch-genconditions.diff
}

if { ${configure.build_arch} eq "i386" && ${os.major} >= 10 } {

    # fix no-pie clang bug bootstrapping gcc on i386
    # https://trac.macports.org/ticket/63161
    patchfiles-append  patch-gcc10-i686-clang-bootstrap-fix.diff
}

platform darwin {
    configure.pre_args-append --build=${build_arch}-apple-darwin${os.major}
}

# clang (as) from Xcode 12.5 has various problems with gcc build
if { ${os.platform} eq "darwin" && \
         ([vercmp ${xcodeversion} >= 12.5] || [vercmp ${xcodecltversion} >= 12.5]) } {
    pre-configure {
        ui_warn "Applying '--without-build-config' workaround to Xcode ${xcodeversion} / CLT ${xcodecltversion}"
        ui_warn "If versions > 12.5 please check if it is still required"
    }
    # gcc has build issues on macOS 11.3 with the use of Xcode clang as 'as'
    # https://gcc.gnu.org/bugzilla/show_bug.cgi?id=100340
    # https://trac.macports.org/ticket/62775
    configure.args-append  --without-build-config
}

# https://trac.macports.org/ticket/65415
# Need to disable bootstrap comparisons here as well
if { ${os.platform} eq "darwin" && ${os.major} < 15 } {
    configure.args-append  --without-build-config
}

# https://trac.macports.org/ticket/58493
compiler.blacklist-append {clang < 800} gcc-4.0 *gcc-4.2 {macports-clang-3.[4-7]}

# https://trac.macports.org/ticket/65415
compiler.blacklist-append {macports-clang-1[2-9]}

# "-stdlib" would be passed on to the bootstrap compiler if present
configure.cxx_stdlib

# gcc cannot build if libunwind-headers is active
conflicts_build-append libunwind-headers

libgcc.keep libasan.5.dylib libgcc_ext.10.4.dylib libgcc_ext.10.5.dylib

platform powerpc {
    configure.universal_archs ppc ppc64
}
platform i386 {
    configure.universal_archs i386 x86_64
}
configure.cc-append [get_canonical_archflags]
configure.cc_archflags
configure.cxx-append ${configure.cxx_archflags}
configure.cxx_archflags
configure.objc_archflags
configure.ld_archflags
configure.universal_cflags
configure.universal_cxxflags
configure.universal_ldflags
configure.universal_args
