# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

PortSystem                              1.0
PortGroup           gcc_build           1.0
PortGroup           xcode_workaround    1.0

name                gcc5
epoch               2
version             5.5.0
revision            6
platforms           {darwin >= 10 < 15}

description         The GNU compiler collection
long_description    The GNU compiler collection, including front ends for \
                    C, C++, Objective-C, Objective-C++, Fortran and Java.

dist_subdir         gcc

set ecj             ecj-4.9.jar

gcc.tag             :gcc
master_sites-append ftp://sourceware.org/pub/java/:ecj \
                    http://mirrors.kernel.org/sources.redhat.com/java/:ecj \
                    https://www.mirrorservice.org/sites/sources.redhat.com/pub/java/:ecj \
                    http://ftp-stud.fht-esslingen.de/pub/Mirrors/sourceware.org/java/:ecj

distfiles           ${distname}${extract.suffix}:gcc ${ecj}:ecj

extract.only        ${distname}${extract.suffix}

checksums           ${distname}${extract.suffix} \
                    rmd160  63fdc006c2289f81df664d1fd9b4124f71732e7b \
                    sha256  530cea139d82fe542b358961130c69cfde8b3d14556370b65823d2f91f0ced87 \
                    size    71096120 \
                    ${ecj} \
                    rmd160  eb1b19d9ac0e9e265bf993f38b9576e3c710e91e \
                    sha256  9506e75b862f782213df61af67338eb7a23c35ff425d328affc65585477d34cd \
                    size    1619429

if { ${configure.build_arch} ne "i386" } {
    # TODO: does this work with universal?
    # TODO: most other GCC ports apply this to all architectures
    gcc.macports_exports-delete DISABLE_MACPORTS_AS_CLANG_SEARCH=1 \
                                DISABLE_XCODE_AS_CLANG_SEARCH=1
}

# Work around parallel building issue on APFS
# https://gcc.gnu.org/bugzilla/show_bug.cgi?id=81797
patchfiles-append   notparallel-install-headers.patch

# Provide linkage for MacPorts libiconv in gcj
patchfiles-append   gcj-libiconv-linkage.patch

# work around bug in 10.13 headers
patchfiles-append   headers-10.13-fix.patch

# See https://trac.macports.org/ticket/53662 for a similar issue
patchfiles-append   patch-libisl.diff
post-extract {
    ln -s ${prefix}/libexec/isl18/include/isl ${worksrcpath}/gcc
}

patchfiles-append   patch-gcj-unwind.diff

if {[vercmp ${xcodeversion} 10.2] >= 0} {
    # https://trac.macports.org/ticket/58260
    # Patch for Xcode bug, taken from
    # https://gcc.gnu.org/bugzilla/show_bug.cgi?id=89864#c43
    # https://github.com/Homebrew/homebrew-core/pull/39134/files
    patchfiles-append   xcode-bug-_Atomic-fix.patch
}

post-extract {
    copy ${distpath}/${ecj} ${worksrcpath}/ecj.jar
}

platform darwin {
    if {${os.major} > 14} {
        # Hack around boehm-gc and associated gcj failures from recompilation
        # of libunwind.dylib with Apple Clang in macOS >= 10.11 by reducing
        # alignment to 2
        patchfiles-append   boehm-gc-darwin15-hack.patch
    }
}

platform darwin 11 {
    # work around a hiccup building this due to MacPort's cctools modifications
    # that forces the use of /usr/bin/clang as assembler, which doesn't work for gcc5 on 10.7.5
    # any clang >= 5.0 would work, but at present, all 10.7.5 users will have clang-9.0
    # https://trac.macports.org/ticket/62072
    # TODO: find a way to force "gas" as assembler
    depends_build-append port:clang-9.0
}

# http://trac.macports.org/ticket/29067
compiler.blacklist-append gcc-4.0

# http://trac.macports.org/ticket/29104
compiler.blacklist-append {llvm-gcc-4.2 < 2336.1}

# https://trac.macports.org/ticket/47996
compiler.blacklist-append {clang < 300}

post-destroot {
    move ${destroot}${prefix}/lib/${name}/pkgconfig/libgcj-${gcc.suffix}.pc ${destroot}${prefix}/lib/pkgconfig/
}
